<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Test Custom Statistic (No Format Function)</title>
  <style>
    body { margin: 0; background: #000; font-family: system-ui; }
    #container { width: 100vw; height: 100vh; }
    #info {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0,10,20,0.9);
      color: #fff;
      padding: 16px;
      border-radius: 8px;
      max-width: 300px;
      z-index: 1000;
    }
    #info h3 { margin: 0 0 8px 0; color: #4af; }
    #info p { margin: 4px 0; font-size: 14px; color: #aaa; }
    #info .test { color: #4f4; }
    #info .fail { color: #f44; }
  </style>
</head>
<body>
  <div id="container"></div>
  <div id="info">
    <h3>Test: Custom Statistic</h3>
    <p>This simulates what maptheory sends via JSON API:</p>
    <p>- StatisticData <strong>WITHOUT</strong> format function</p>
    <p>- Should show "Smartphone Ownership" in legend</p>
    <p>- Labels should NOT float off globe edges</p>
    <hr style="border-color: #333; margin: 12px 0;">
    <p id="legend-test">Legend test: <span>checking...</span></p>
    <p id="labels-test">Labels test: <span>rotate globe to verify</span></p>
  </div>

  <script type="module">
    import { GlobeViz } from './src/lib/GlobeViz.ts';

    // Simulate what maptheory sends via JSON (NO format function - it can't be serialized)
    const customStatistic = {
      definition: {
        id: "smartphone_ownership",
        name: "Smartphone Ownership Percentage",
        unit: "%",
        description: "Percentage of population owning a smartphone",
        colorScale: ["#fee5d9", "#fcae91", "#cb181d"],
        domain: [20, 95]
        // NOTE: No format function! This is the test case.
      },
      values: {
        "840": 85,  // USA
        "156": 68,  // China
        "356": 42,  // India
        "392": 78,  // Japan
        "276": 82,  // Germany
        "826": 80,  // UK
        "250": 77,  // France
        "076": 71,  // Brazil
        "643": 73,  // Russia
        "484": 69,  // Mexico
        "036": 83,  // Australia
        "124": 81,  // Canada
        "410": 95,  // South Korea
        "724": 79,  // Spain
        "380": 76,  // Italy
        "528": 88,  // Netherlands
        "752": 86,  // Sweden
        "578": 87,  // Norway
        "792": 74,  // Turkey
        "616": 72,  // Poland
        "566": 35,  // Nigeria
        "818": 54,  // Egypt
        "682": 91,  // Saudi Arabia
        "784": 93,  // UAE
        "458": 89,  // Malaysia
        "702": 92,  // Singapore
        "704": 65,  // Vietnam
        "360": 58,  // Indonesia
        "586": 38,  // Pakistan
        "050": 45,  // Bangladesh
        "710": 60,  // South Africa
        "404": 48,  // Kenya
        "231": 25,  // Ethiopia
      }
    };

    // Initialize globe
    const globe = new GlobeViz('#container', {
      texture: 'satellite',
      autoRotate: true,
      showLegend: true,
      showControls: false,
      labels: 'major',
      effects: {
        atmosphere: true,
        clouds: true,
      }
    });

    // Wait a bit for globe to initialize, then set custom statistic
    setTimeout(() => {
      console.log('Setting custom statistic (without format function)...');
      globe.setStatistic(customStatistic);
      
      // Check if legend updated correctly
      setTimeout(() => {
        const legendTitle = document.querySelector('.legend-title');
        const legendMin = document.querySelector('.legend-min');
        const legendMax = document.querySelector('.legend-max');
        
        const testEl = document.querySelector('#legend-test span');
        
        if (legendTitle && legendTitle.textContent === 'Smartphone Ownership Percentage') {
          if (legendMin && legendMax && legendMin.textContent && legendMax.textContent) {
            testEl.className = 'test';
            testEl.textContent = `PASS! Title: "${legendTitle.textContent}", Range: ${legendMin.textContent} - ${legendMax.textContent}`;
          } else {
            testEl.className = 'fail';
            testEl.textContent = 'FAIL - min/max labels not formatted';
          }
        } else {
          testEl.className = 'fail';
          testEl.textContent = `FAIL - Title is "${legendTitle?.textContent || 'not found'}"`;
        }
      }, 500);
    }, 2000);
  </script>
</body>
</html>
